#!/bin/sh
#
# configure - generate a Makefile for lynxbot

debug=false
prefix="/usr/local"
target="native"
cross_prefix=
progname=lynxbot
LDFLAGS='-lcurl -lpthread -lcrypto'
winbuild=0

while [ "$1" ]; do
	case "$1" in
		--debug)
			debug=true
			shift
			;;
		--help)
			echo "usage: ./configure [OPTION]..."
			echo
			echo "    --debug"
			echo "        compile with debug symbols"
			echo "    --help"
			echo "        show this help information"
			echo "    --prefix=PATH"
			echo "        set installation prefix to PATH"
			echo "    --target=TARG"
			echo "        set target architecture to TARG"
			echo "        accepted values: native, linux-x86_64, mingw64"
			exit 0
			;;
		--prefix=*)
			prefix=`echo "$1" | sed 's/--prefix=//'`
			shift
			;;
		--target=*)
			target=`echo "$1" | sed 's/--target=//'`
			if [ ! $target = "linux-x86_64" -a ! $target = "mingw64" \
				-a ! $target = "native" ]; then
				echo "invalid target: $target" >&2
				echo "see ./configure --help for details" >&2
				exit 1
			fi
			shift
			;;
		-*) echo invalid option "$1" >&2; exit 1;;
		*) echo "usage: ./configure [OPTION]..." >&2; exit 1;;
	esac
done

echo PREFIX=$prefix > Makefile
if [ $target = "mingw64" ]; then
	progname="${progname}.exe"
	cross_prefix="x86_64-w64-mingw32-"
	LDFLAGS="-L/usr/x86_64-w64-mingw32/lib -lws2_32 -static-libgcc -static-libstdc++ $LDFLAGS"
	winbuild=1
	echo "RES=${cross_prefix}windres" >> Makefile
	echo "RESFLAGS=-O coff" >> Makefile
elif [ $target = "linux-x86_64" ]; then
	cross_prefix="x86_64-pc-linux-gnu-"
else
	target=`uname -sm | tr ' ' - | tr [:upper:] [:lower:]`
fi
if $debug; then
	progname="${progname}-d"
	echo OBJ=obj/$target/dbg >> Makefile
	echo CFLAGS+=-DDEBUG -g >> Makefile
	echo CXXFLAGS+=-DDEBUG -g >> Makefile
else
	echo OBJ=obj/$target/rel >> Makefile
	echo CFLAGS+=-O2 >> Makefile
	echo CXXFLAGS+=-O2 >> Makefile
fi

echo "CC=${cross_prefix}gcc" >> Makefile
echo "CXX=${cross_prefix}g++" >> Makefile
echo "LDFLAGS=$LDFLAGS" >> Makefile
echo "WINBUILD=$winbuild" >> Makefile

echo PROGNAME=$progname >> Makefile
echo USR=$USER >> Makefile
echo CONFDIR=$HOME/.lynxbot >> Makefile

cat Makefile.in >> Makefile
echo "LynxBot configured"
echo "Target architecture:	$target"
echo "Debugging symbols:	$debug"
echo "Output file:		$progname"
echo "Installation prefix:	$prefix"
echo Type \'make\' to build
